# Planet Nine Path-Based Nginx Configuration
# Routes all services through single domain with path-based routing
# Example: https://mybase.com/bdo/, https://mybase.com/sanora/, etc.

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name _;  # Catch-all for any domain
    return 301 https://$host$request_uri;
}

# Main HTTPS server with path-based routing
server {
    listen 443 ssl http2;
    server_name _;  # Replace with your actual domain (e.g., mybase.com)

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/server.crt;        # Update path to your SSL cert
    ssl_certificate_key /etc/ssl/private/server.key;  # Update path to your SSL key

    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # General proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300;
    proxy_connect_timeout 300;

    # Large file uploads for dolores (video service)
    client_max_body_size 100M;

    # Core Planet Nine Services

    # BDO - Big Dumb Object Storage
    location /bdo/ {
        proxy_pass http://localhost:3003/;
    }

    # Fount - MAGIC Protocol & Nineum
    location /fount/ {
        proxy_pass http://localhost:3002/;
    }

    # Addie - Payment Processing
    location /addie/ {
        proxy_pass http://localhost:3005/;
    }

    # Sanora - Product Hosting
    location /sanora/ {
        proxy_pass http://localhost:7243/;
    }

    # Dolores - Social Feeds & Media
    location /dolores/ {
        proxy_pass http://localhost:3007/;
    }

    # Covenant - Contract Management
    location /covenant/ {
        proxy_pass http://localhost:3011/;
    }

    # Additional Services

    # Pref - Preferences Storage
    location /pref/ {
        proxy_pass http://localhost:3001/;
    }

    # Continuebee - State Verification
    location /continuebee/ {
        proxy_pass http://localhost:3000/;
    }

    # Joan - Account Recovery
    location /joan/ {
        proxy_pass http://localhost:3004/;
    }

    # Julia - P2P Messaging
    location /julia/ {
        proxy_pass http://localhost:3006/;
    }

    # Minnie - Email Handling
    location /minnie/ {
        proxy_pass http://localhost:3009/;
    }

    # Aretha - Limited-Run Products
    location /aretha/ {
        proxy_pass http://localhost:3010/;
    }

    # Prof - Profile Management
    location /prof/ {
        proxy_pass http://localhost:3008/;
    }

    # Base Discovery & Health Check Endpoints

    # Base announcement endpoint for network discovery
    location /network/ {
        proxy_pass http://localhost:3003/;  # Route to BDO for base registry
    }

    # Health check endpoint
    location /health {
        proxy_pass http://localhost:3003/health;
    }

    # Service discovery endpoint - lists all available services
    location /services {
        default_type application/json;
        return 200 '{
            "base": "$host",
            "services": [
                {"name": "bdo", "path": "/bdo/", "port": 3003, "description": "Big Dumb Object Storage"},
                {"name": "fount", "path": "/fount/", "port": 3002, "description": "MAGIC Protocol & Nineum"},
                {"name": "addie", "path": "/addie/", "port": 3005, "description": "Payment Processing"},
                {"name": "sanora", "path": "/sanora/", "port": 7243, "description": "Product Hosting"},
                {"name": "dolores", "path": "/dolores/", "port": 3007, "description": "Social Feeds & Media"},
                {"name": "covenant", "path": "/covenant/", "port": 3011, "description": "Contract Management"},
                {"name": "pref", "path": "/pref/", "port": 3001, "description": "Preferences Storage"},
                {"name": "continuebee", "path": "/continuebee/", "port": 3000, "description": "State Verification"},
                {"name": "joan", "path": "/joan/", "port": 3004, "description": "Account Recovery"},
                {"name": "julia", "path": "/julia/", "port": 3006, "description": "P2P Messaging"},
                {"name": "minnie", "path": "/minnie/", "port": 3009, "description": "Email Handling"},
                {"name": "aretha", "path": "/aretha/", "port": 3010, "description": "Limited-Run Products"},
                {"name": "prof", "path": "/prof/", "port": 3008, "description": "Profile Management"}
            ],
            "timestamp": "$time_iso8601"
        }';
    }

    # Root endpoint - base information
    location = / {
        default_type application/json;
        return 200 '{
            "base": "$host",
            "name": "Planet Nine Base",
            "version": "1.0.0",
            "endpoints": {
                "services": "/services",
                "health": "/health",
                "network": "/network/"
            },
            "timestamp": "$time_iso8601"
        }';
    }

    # Optional: Catch-all for undefined paths
    location / {
        default_type application/json;
        return 404 '{
            "error": "Service not found",
            "available_services": "/services",
            "timestamp": "$time_iso8601"
        }';
    }
}

# Optional: Specific configuration for API documentation or admin interface
# server {
#     listen 8080;
#     server_name _;
#
#     location / {
#         root /var/www/admin;
#         index index.html;
#     }
# }